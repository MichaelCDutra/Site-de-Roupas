// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. Usuário (Dono da conta)
model Usuario {
  id           Int      @id @default(autoincrement())
  nomeCompleto String
  email        String   @unique
  senhaHash    String
  dataCriacao  DateTime @default(now())
  lojas        Loja[]
}

model Loja {
  id           Int       @id @default(autoincrement())
  nomeLoja     String
  slug         String    @unique 
  customDomain String?   @unique 
  corPrimaria  String    @default("#000000") 
  logoUrl      String?   
  whatsapp     String?   
  
  usuarioId    Int
  usuario      Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  produtos     Produto[]
  categorias   Categoria[]
  vendas       Venda[]
  notificacoes Notificacao[]
}

// 3. Categorias
model Categoria {
  id      Int      @id @default(autoincrement())
  nome    String
  ativa   Boolean  @default(true)
  
  lojaId  Int
  loja    Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  produtos Produto[]
}

// 4. Produtos (Ajustado para Inventário por Grade)
model Produto {
  id          Int       @id @default(autoincrement())
  titulo      String
  descricao   String?   @db.Text
  preco       Decimal   @db.Decimal(10, 2)
  image       String?
  ativo       Boolean   @default(true)
  
  // Relacionamento com a Grade (Tamanhos/Cores/Estoque)
  variacoes   Variacao[]

  lojaId      Int
  loja        Loja      @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  categoriaId Int?
  categoria   Categoria? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  itensVenda  ItemVenda[] 
}

// NOVO: 4.1 Grade de Estoque (Variações de Tamanho/Cor)
model Variacao {
  id         Int      @id @default(autoincrement())
  tamanho    String   // P, M, G, GG, 38, 40...
  cor        String?  // Opcional: Azul, Branco, Estampado...
  quantidade Int      @default(0) // Quantidade específica deste tamanho

  produtoId  Int
  produto    Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)
}

// 5. Vendas
model Venda {
  id              Int      @id @default(autoincrement())
  clienteNome     String?
  clienteWhatsapp String?
  totalVenda      Decimal  @db.Decimal(10, 2)
  status          StatusVenda @default(AGUARDANDO)
  dataVenda       DateTime @default(now())

  lojaId          Int
  loja            Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  itens           ItemVenda[]
}

// 6. Itens da Venda
model ItemVenda {
  id              Int      @id @default(autoincrement())
  quantidade      Int
  precoNoMomento  Decimal  @db.Decimal(10, 2)
  
  // Opcional: Salvar qual tamanho foi vendido para histórico
  tamanhoVendido  String?

  vendaId         Int
  venda           Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  produtoId       Int?
  produto         Produto? @relation(fields: [produtoId], references: [id])
}

// 7. Notificações
model Notificacao {
  id          Int      @id @default(autoincrement())
  mensagem    String
  lida        Boolean  @default(false)
  tipo        TipoNotificacao @default(SISTEMA)
  dataCriacao DateTime @default(now())

  lojaId      Int
  loja        Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)
}

enum StatusVenda {
  AGUARDANDO
  PAGO
  ENVIADO
  CANCELADO
}

enum TipoNotificacao {
  VENDA
  ESTOQUE
  SISTEMA
}