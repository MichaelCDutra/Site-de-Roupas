// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. Usuário (Dono da conta / Lojista / SuperAdmin)
model Usuario {
  id        String   @id @default(uuid())
  nome      String   // Ajustado para bater com o controller
  email     String   @unique
  senha     String   // Ajustado para bater com o controller
  role      String   @default("LOJISTA") // "LOJISTA" ou "SUPERADMIN"
  ativo     Boolean  @default(true)      // Bloqueio de acesso

  primeiroAcesso Boolean @default(true)
  
  createdAt DateTime @default(now())     // Ajustado para bater com o controller
  updatedAt DateTime @updatedAt
  // Relação 1-1: Um usuário tem uma única loja (no modelo SaaS simples)
  loja      Loja?    
}

model Loja {
  id           String   @id @default(uuid())
  nomeLoja     String
  slug         String   @unique 
  customDomain String?  @unique 
  corPrimaria  String   @default("#000000") 
  logoUrl      String?   
  whatsapp     String?   
  
  usuarioId    String   @unique // @unique garante a relação 1-to-1
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  produtos     Produto[]
  categorias   Categoria[]
  vendas       Venda[]
  notificacoes Notificacao[]
}

// 3. Categorias
model Categoria {
  id      String  @id @default(uuid())
  nome    String
  ativa   Boolean @default(true)
  
  lojaId  String
  loja    Loja    @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  produtos Produto[]
}

// 4. Produtos
model Produto {
  id          String   @id @default(uuid())
  titulo      String
  descricao   String?  @db.Text
  preco       Decimal  @db.Decimal(10, 2)
  image       String?
  ativo       Boolean  @default(true)
  
  variacoes   Variacao[]

  lojaId      String
  loja        Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  categoriaId String? 
  categoria   Categoria? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  itensVenda  ItemVenda[] 
}

// 4.1 Grade de Estoque
model Variacao {
  id         String  @id @default(uuid())
  tamanho    String  
  cor        String? 
  quantidade Int     @default(0)

  produtoId  String
  produto    Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)
}

// 5. Vendas
model Venda {
  id              String      @id @default(uuid())
  clienteNome     String?
  clienteWhatsapp String?
  totalVenda      Decimal     @db.Decimal(10, 2)
  status          StatusVenda @default(AGUARDANDO)
  dataVenda       DateTime    @default(now())

  lojaId          String
  loja            Loja        @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  itens           ItemVenda[]
}

// 6. Itens da Venda
model ItemVenda {
  id             String   @id @default(uuid())
  quantidade     Int
  precoNoMomento Decimal  @db.Decimal(10, 2)
  tamanhoVendido String?

  vendaId        String
  venda          Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  produtoId      String?
  produto        Produto? @relation(fields: [produtoId], references: [id])
}

// 7. Notificações
model Notificacao {
  id          String          @id @default(uuid())
  mensagem    String
  lida        Boolean         @default(false)
  tipo        TipoNotificacao @default(SISTEMA)
  dataCriacao DateTime        @default(now())

  lojaId      String
  loja        Loja            @relation(fields: [lojaId], references: [id], onDelete: Cascade)
}

enum StatusVenda {
  AGUARDANDO
  PAGO
  ENVIADO
  CANCELADO
  ENTREGUE
}

enum TipoNotificacao {
  VENDA
  ESTOQUE
  SISTEMA
}